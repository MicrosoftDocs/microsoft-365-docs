---
title: Authenticated scan for Windows in Defender Vulnerability Management
description: Find out about how to create Authenticated scans for Windows
keywords: Microsoft Defender Vulnerability Management, authenticated scans
search.appverid: MET150
author: siosulli
ms.author: siosulli
manager: dansimp
audience: Admin
ms.topic: conceptual
ms.service: microsoft-365-security
ms.subservice: mdvm
ms.localizationpriority: medium
ms.date: 05/12/2022
ms.collection:
 - m365-security
 - m365-security-compliance
 - tier1

---

# Authenticated scan for Windows

[!INCLUDE [Microsoft 365 Defender rebranding](../../includes/microsoft-defender.md)]

**Applies to:**

- [Microsoft Defender for Endpoint Plan 2](https://go.microsoft.com/fwlink/?linkid=2154037)
- [Microsoft Defender Vulnerability Management](index.yml)
- [Microsoft 365 Defender](https://go.microsoft.com/fwlink/?linkid=2118804)

[!include[Prerelease information](../../includes/prerelease.md)]

>[!Note]
>Want to experience Microsoft Defender Vulnerability Management? Learn more about how you can sign up to the [Microsoft Defender Vulnerability Management public preview trial](../defender-vulnerability-management/get-defender-vulnerability-management.md).

Authenticated scan for Windows provides the ability to run scans on unmanaged Windows devices. You can remotely target by IP ranges or hostnames and scan Windows services by providing Microsoft Defender Vulnerability Management with credentials to remotely access the devices. Once configured the targeted unmanaged devices will be scanned regularly for software vulnerabilities.

This is applicable for devices that don't have the Defender Vulnerability Management or Defender for Endpoint agent deployed.

## Scanner Installation

Similar to [network device](../defender-endpoint/network-devices.md) authenticated scan, you'll need a scanning device with the scanner installed. If you don’t already have the scanner installed, see [Install the scanner](../defender-endpoint/network-devices.md#install-the-scanner) for steps on how to download and install it.

>[!NOTE]
> No changes are required for pre-existing installed scanners.

## Pre-requisites

The following section lists the pre-requisites you need to configure to use Authenticated scan for Windows.

### Scanning account

A scanning account is required to remotely access the devices. This must be a [Group Managed Service Account (gMsa)](/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview/). To create a gMsa account:

1. On your domain controller in a PowerShell window, run:

```powershell
New-ADServiceAccount -name gmsa1 -PrincipalsAllowedToRetrieveManagedPassword scanner-win11-i$ -KerberosEncryptionType RC4, AES128, AES256 –verbose
```

   - gmsa1 stands for the name of the account you are creating, and scanner-win11-I$ stands for the machine name where the scanner agent will run. Only this machine will be able to retrieve the account password. You can provide a comma separated list of machines.
   - Modifying an existing account can be done with *Get-ADServiceAccount* and *Set-ADServiceAccount*

2. To Install the AD Service Account, on the machine where the scanner agent will run using an elevated PowerShell window, run:

```powershell
Install-ADServiceAccount -Identity gmsa1
```

If your PowerShell doesn’t recognize those commands, it probably means you're missing a required PowerShell module. Instructions on how to install the module vary depending on your operating system. For more information, see [Getting Started with Group Managed Service Accounts](/windows-server/security/group-managed-service-accounts/getting-started-with-group-managed-service-accounts/).

### Devices to be scanned

Use the table below for guidance on:

- The configurations required on the device to be scanned
- The permissions required on the devices to scanned for the account that will be used to scan the device

>[!NOTE]
> The below steps are one recommended way to configure the permissions on the devices to be scanned and uses the Performance Monitor Users group. You can also configure the permissions in the following ways:
>
> - add the account to a different user group and give all the permissions required to that group
> - give these permissions explicitly to the scanning account
> - use a group policy to apply these permissions on all the devices to be scanned at once. For more information, see [Use a group policy to configure devices to be scanned](#use-a-group-policy-to-configure-devices-to-be-scanned).

| Devices to be scanned requirements | Description |
|:---|:---|
|Windows Management Instrumentation (WMI) and Registry is enabled (without registry)| To enable remote Windows Management Instrumentation (WMI): </br> </br> - Verify the Windows Management Instrumentation service is running. </br> - Go to **Control Panel** &gt; **All Control Panel Items** &gt; **Windows Defender Firewall** &gt; **Allowed applications** and ensure Windows Management Instrumentation (WMI) is allowed through Windows Firewall.|
|Scanning account is a member of Performance Monitor Users group| The scanning account must be a member of the **Performance Monitor Users** group on the device to be scanned.|
|Performance Monitor Users group has 'Enable Account' and 'Remote Enable' permissions on Root/CIMV2 WMI namespace | To verify or enable these permissions: </br> </br> - Run wmimgmt.msc </br> - Right click **WMI Control (Local)** and select **Properties**</br> - Go to the Security tab</br> - Select the relevant WMI namespace and select **Security**</br> - Add the specified group and select to allow the specific permissions</br> - Select **Advanced**, choose the specified entry, and select **Edit**</br> - Set **Applies To** to “This namespace and subnamespaces”|
|**Performance Monitor Users** group should have permissions on DCOM operations| To verify or enable these permissions: </br></br> - Run dcomcnfg </br> - Navigate to **Component Services** > **Computers** > **My Computer** </br> - Right click My Computer and choose **Properties** </br> - Go to the COM Security tab </br> - Go to **Launch and Activation Permissions**  and select **Edit Limits** </br> - Add the specified group and select to allow **Remote Activation** |

### Use a group policy to configure devices to be scanned

To apply the permissions on all devices to be scanned at the same time you'll need to follow the steps below on the Domain Controller:

| Step | Description |
|:---|:---|
|Create a new Group Policy Object| - On the domain controller open the Group Policy Management (GPO) console. (add link). </br> - Right-click your GPO and select **Edit** to open the Group Policy Management Editor console. </br> - Create a new Group Policy Object and link it to the relevant group of devices to be scanned. (add link).|
|Enable Windows Management Instrumentation (WMI)| To enable remote Windows Management Instrumentation (WMI): </br> </br> Go to  **Computer Configuration** &gt; **Policies** &gt; **Windows Settings** &gt; **Security Settings** &gt; **System Services**| </br> - Select the **Define this policy setting** box and choose **Automatic**|
|Allowing WMI through firewall| To allow Windows Management Instrumentation (WMI) through the firewall: </br> </br> Go to **Computer Configuration** &gt; **Policies** &gt; **Windows Settings** &gt; **Security Settings** &gt; **Windows Defender Firewall and Advanced Security** &gt; **Inbound Files** </br> - Right-click anywhere on the screen and select **New Rule** </br> - Choose **Predefined** and select **Windows Management Instrumentation (WMI)** from the list and select **Next** </br> - Select the **Windows Management Instrumentation (WMI-In)** checkbox and select **Next** </br> - Select **Allow the connection** and select **Finish**. </br> - Right-click the newly added rule, select **Properties** </br> - Go to Advanced tab, and uncheck the Private and Public options, as only the Domain box is required.|
|Grant permissions to perform DCOM operations| To grant permissions to perform DCOM operations: </br> </br> Go to **Computer Configuration** &gt; **Policies** &gt; **Windows Settings** &gt; **Security Settings** &gt; **Local Policies** &gt; **Security Operations** </br> - Right-click **DCOM: Machine Launch Restrictions in Security Descriptor Definition Language (SDDL) syntax** and select **Properties** </br> - Select **Define this policy setting** box and select **Edit Security** </br> Add the user or group you are granting permissions to, and select **Remote Activation**  |
|Grant permissions to the Root\CIMV2 WMI namespace by running a PowerShell script via group policy: | - Create a PowerShell script file as follows; This script is a recommendation, and you should modify it according to your needs. </br> - Go to **Computer Configuration**&gt; **Policies** &gt; **Windows Settings** &gt;**Scripts (Startup/Shutdown)** &gt; **Startup** - Go to **PowerShell Scripts** tab - Select **Show Files** </br> - Copy the script you created to this folder. </br> - Return to the scripts configuration windows and select **Add** </br> - Enter the script name (file name only) </br> </br> Once the GPO policy is applied to a device, all the required settings will be applied and you gMSA account will be able to access and scan the device. |

## Configure a new authenticated scan

To configure a new authenticated scan:

1. Go to **Settings** > **Device discovery** > **Authenticated scans** in the [Microsoft 365 Defender portal](https://security.microsoft.com).
2. Select **Add new scan** and choose **Windows authenticated scan** and select **Next**.

     :::image type="content" source="../../media/defender-vulnerability-management/authenticated-scan.png" alt-text="Screenshot of the add new authenticated scan screen" lightbox="../../media/defender-vulnerability-management/authenticated-scan.png":::

3. Enter a **Scan name**.
4. Select the **Scanning device:** The onboarded device you'll use to scan the unmanaged devices.
5. Enter the **Target (range):** The IP address ranges or hostnames you want to scan. You can either enter the addresses or import a CSV file. Importing a file will override any manually added addresses.
6. Select the **Scan interval:** By default, the scan will run every four hours, you can change the scan interval or have it only run once, by selecting ‘Do not repeat’.
7. Choose your **Authentication method** - there are two options to choose from:  
    - Kerberos (preferred)
    - Negotiate

    >[!Note]
    > Negotiate option will fallback to NTLM in cases where Kerberos fails. Using NTLM is not recommended as it is not a secure protocol.

8. Enter the credentials Microsoft Defender Vulnerability Management will use to remotely access the devices:

    - **Use azure KeyVault:** If you manage your credentials in Azure KeyVault you can enter the Azure KeyVault URL and Azure KeyVault secret name to be accessed by the scanning device to provide credentials
    - **Enter [gMSA account details](/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview/):** Input the Domain and Username
9. Select **Next** to run or skip the test scan. For more information on test scans, see [Scan and add network devices](../defender-endpoint/network-devices.md#scan-and-add-network-devices).
10. Select **Next** to review the settings and then select **Submit** to create your new authenticated scan.

>[!Note]
>As the authenticated scanner currently uses an encryption algorithm that is not compliant with [Federal Information Processing Standards (FIPS)](/windows/security/threat-protection/security-policy-settings/system-cryptography-use-fips-compliant-algorithms-for-encryption-hashing-and-signing/), the scanner can't operate when an organization enforces the use of FIPS compliant algorithms.
>
> To allow algorithms that are not compliant with FIPS, set the following value in the registry for the devices where the scanner will run: Computer\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\FipsAlgorithmPolicy with a DWORD value named **Enabled** and value of **0x0**
>
>FIPS compliant algorithms are only used in relation to departments and agencies of the United States federal government.

### Authenticated scan for Windows APIs

You can use APIs to create a new scan and view all existing configured scans in your organization. For more information, see:

- [Get all scan definitions](../defender-endpoint/get-all-scan-definitions.md)
- [Add, delete or update a scan definition](../defender-endpoint/add-a-new-scan-definition.md)
- [Get all scan agents](../defender-endpoint/get-all-scan-agents.md)
- [Get scan history by definition](../defender-endpoint/get-scan-history-by-definition.md)
- [Get scan history by session](../defender-endpoint/get-scan-history-by-session.md)

## Related articles

- [Network devices](../defender-endpoint/network-devices.md)
