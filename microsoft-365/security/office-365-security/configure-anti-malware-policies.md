---
title: Configure anti-malware policies
f1.keywords: 
  - NOCSH
ms.author: chrisda
author: chrisda
manager: dansimp
ms.date: 
audience: ITPro
ms.topic: how-to

localization_priority: Normal
search.appverid: 
  - MET150
ms.assetid: b0cfc21f-e3c6-41b6-8670-feb2b2e252e5
ms.collection: 
  - M365-security-compliance
  - m365initiative-defender-office365
description: Admins can learn how to view, create, modify, and remove anti-malware policies in Exchange Online Protection (EOP).
ms.custom: seo-marvel-apr2020
ms.technology: mdo
ms.prod: m365-security
---

# Configure anti-malware policies in EOP

[!INCLUDE [Microsoft 365 Defender rebranding](../includes/microsoft-defender-for-office.md)]

**Applies to**
- [Exchange Online Protection](exchange-online-protection-overview.md)
- [Microsoft Defender for Office 365 plan 1 and plan 2](defender-for-office-365.md)
- [Microsoft 365 Defender](../defender/microsoft-365-defender.md)

In Microsoft 365 organizations with mailboxes in Exchange Online or standalone Exchange Online Protection (EOP) organizations without Exchange Online mailboxes, email messages are automatically protected against malware by EOP. EOP uses anti-malware policies for malware protection settings. For more information, see [Anti-malware protection](anti-malware-protection.md).

Admins can view, edit, and configure (but not delete) the default anti-malware policy to meet the needs of their organizations. For greater granularity, you can also create custom anti-malware policies that apply to specific users, groups, or domains in your organization. Custom policies always take precedence over the default policy, but you can change the priority (running order) of your custom policies.

You can configure anti-malware policies in the Microsoft 365 security center or in PowerShell (Exchange Online PowerShell for Microsoft 365 organizations with mailboxes in Exchange Online; standalone EOP PowerShell for organizations without Exchange Online mailboxes).

## What do you need to know before you begin?

- You open the security center at <https://security.microsoft.com/>. To go directly to the **Anti-malware** page, use <https://security.microsoft.com/antimalwarev2>.

- To connect to Exchange Online PowerShell, see [Connect to Exchange Online PowerShell](/powershell/exchange/connect-to-exchange-online-powershell). To connect to standalone EOP PowerShell, see [Connect to Exchange Online Protection PowerShell](/powershell/exchange/connect-to-exchange-online-protection-powershell).

- You need to be assigned permissions in **Exchange Online** before you can do the procedures in this article:
  - To add, modify, and delete anti-malware policies, you need to be a member of the **Organization Management** or **Security Administrator** role groups.
  - For read-only access to anti-malware policies, you need to be a member of the **Global Reader** or **Security Reader** role groups.

  For more information, see [Permissions in Exchange Online](/exchange/permissions-exo/permissions-exo).

  **Notes**:

  - Adding users to the corresponding Azure Active Directory role in the Microsoft 365 admin center gives users the required permissions _and_ permissions for other features in Microsoft 365. For more information, see [About admin roles](../../admin/add-users/about-admin-roles.md).
  - The **View-Only Organization Management** role group in [Exchange Online](/Exchange/permissions-exo/permissions-exo#role-groups) also gives read-only access to the feature.

- For our recommended settings for anti-malware policies, see [EOP anti-malware policy settings](recommended-settings-for-eop-and-office365.md#eop-anti-malware-policy-settings).

## Use the security center to create anti-malware policies

Creating a custom anti-malware policy in the security center creates the malware filter rule and the associated malware filter policy at the same time using the same name for both.

1. In the security center, go to **Email & Collaboration** \> **Policies & Rules** \> **Threat policies** \> **Anti-Malware**, and then click ![Create icon](../../media/m365-cc-sc-create-icon.png) **Create**.

2. The policy wizard opens. On the **Name your policy page**, configure these settings:
   - **Name**: Enter a unique, descriptive name for the policy.
   - **Description**: Enter an optional description for the policy.

   When you're finished, click **Next**.

3. On the **Users and domains** page that appears, identify the internal recipients that the policy applies to (recipient conditions):
   - **Users**: The specified mailboxes, mail users, or mail contacts in your organization.
   - **Groups**: The specified distribution groups, mail-enabled security groups, or Microsoft 365 Groups in your organization.
   - **Domains**: All recipients in the specified [accepted domains](/exchange/mail-flow-best-practices/manage-accepted-domains/manage-accepted-domains) in your organization.

   Click in the appropriate box, start typing a value, and select the value that you want from the results. Repeat this process as many times as necessary. To remove an existing value, click remove ![Remove icon](../../media/m365-cc-sc-remove-selection-icon.png) next to the value.

   For users or groups, you can use most identifiers (name, display name, alias, email address, account name, etc.), but the corresponding display name is shown in the results. For users, enter an asterisk (\*) by itself to see all available values.

   Multiple values in the same condition use OR logic (for example, _\<recipient1\>_ or _\<recipient2\>_). Different conditions use AND logic (for example, _\<recipient1\>_ and _\<member of group 1\>_).

   - **Exclude these users, groups, and domains**: To add exceptions for the internal recipients that the policy applies to (recpient exceptions), select this option and configure the exceptions. The settings and behavior are exactly like the conditions.

   When you're finished, click **Next**.

4. On the **Protection settings** page that appears, configure the following settings:

   - **Enable the common attachments filter**: If you select this option, messages with the specified attachments are treated as malware and are automatically quarantined. You can modify the default list by selecting **Customize file types**.

   - **Enable zero-hour auto purge for malware**: If you select this option, ZAP quarantines malware messages that have already been delivered. For more information, see [Zero-hour auto purge (ZAP) in Exchange Online](zero-hour-auto-purge.md). Select one of these values:

   - **Notify recipients when messages are quarantined as malware**:
     - If you select this option, the message is quarantined with no notification to the intended recipients.
     - If you don't select this option, the message is quarantined. A copy of the message is delivered to the recipients, but *all* attachments (not just the detected ones) are replaced with a single text file named **Malware Alert Text.txt**.

       The default text in the replacement text file is described in [Anti-malware policies](anti-malware-protection.md#anti-malware-policies). To use custom text instead, enter the text in the **Custom notification text to recipient** box.

   - **Sender Notifications**: Select none, one, or both of these options:
       - **Notify internal senders when messages are quarantined as malware**: An internal sender is inside the organization.
       - **Notify external senders when messages are quarantined as malware**: An external sender is outside the organization.

   - **Admin notifications**: Select none, one, or both of these options:
       - **Notify an admin about undelivered messages from internal senders**: If you select this option, enter a notification email address in the **Admin email address** box that appears.
       - **Notify an admin about undelivered messages from external senders**: If you select this option, enter a notification email address in the **Admin email address** box that appears.

   - **Customize notifications**: These settings replace the default notification text that's used for senders or admins. For more information about the default values, see [Anti-malware policies](anti-malware-protection.md#anti-malware-policies).
       - **Use customized notification text**: If you select this option, you need to use the **From name** and **From address** boxes to specify the sender's name and email address that's used in the customized notification message.
       - **Customize notifications for messages from internal senders**: If you chose to notify senders or admins about undeliverable messages from internal senders, you need to use the **Subject** and **Message** boxes to specify the subject and message body of the custom notification message.
       - **Customize notifications for messages from external senders**: If you chose to notify senders or admins about undeliverable messages from external senders, you need to use the **Subject** and **Message** boxes to specify the subject and message body of the custom notification message.

   When you're finished, click **Next**.

5. On the **Review** page that appears, review your settings. You can select **Edit** in each section to modify the settings within the section.

   When you're finished, click **Submit**.

6. On the confirmation page that appears, click **Done**.

## Use the security center to view anti-malware policies

1. In the security center, go to **Email & Collaboration** \> **Policies & Rules** \> **Threat policies** \> **Anti-malware**.

   The following properties are displayed on the page:

   - **Name**
   - **Status**
   - **Priority**

2. When you select a policy by clicking on the name, the policy settings are displayed in a flyout.

## Use the security center to modify anti-malware policies

1. In the security center, go to **Email & Collaboration** \> **Policies & Rules** \> **Threat policies** \> **Anti-malware**.

2. Select a policy from the list by clicking on the name of the policy.

3. In the policy details flyout that appears, select **Edit** in each section to modify the settings within the section. For more information about the settings, see the previous [Use the security center to create anti-malware policies](#use-the-security-center-to-create-anti-malware-policies) section in this article.  

   For the default anti-malware policy, the **Users and domains** section isn't available (the policy applies to everyone), and you can't rename the policy.

## Use the security center to enable or disable anti-malware policies

You can't disable the default anti-malware policy.

1. In the security center, go to **Email & Collaboration** \> **Policies & Rules** \> **Threat policies** \> **Anti-malware**.

2. Select a custom policy from the list by clicking on the name of the policy. At the top of the policy details flyout that appears, you'll see one of the following values:
   - **Policy off**: To turn on the policy, click ![Turn on icon](../../media/m365-cc-sc-turn-on-off-icon.png) **Turn on** .
   - **Policy on**: To turn off the policy, click ![Turn off icon](../../media/m365-cc-sc-turn-on-off-icon.png) **Turn off**.

3. In the confirmation dialog that appears, click **Turn on** or **Turn off**.

4. Click **Close** in the policy details flyout.

Back on the main policy page, the **Status** value of the policy will be **On** or **Off**.

## Use the security center to set the priority of custom anti-malware policies

By default, anti-malware policies are given a priority that's based on the order they were created in (newer policies are lower priority than older policies). A lower priority number indicates a higher priority for the policy (0 is the highest), and policies are processed in priority order (higher priority policies are processed before lower priority policies). No two policies can have the same priority, and policy processing stops after the first policy is applied.

To change the priority of a policy, you click **Increase priority** or **Decrease priority** in the properties of the policy (you can't directly modify the **Priority** number in the security center). Changing the priority of a policy only makes sense if you have multiple policies.

 **Notes**:

- In the security center, you can only change the priority of the anti-malware policy after you create it. In PowerShell, you can override the default priority when you create the malware filter rule (which can affect the priority of existing rules).
- Anti-malware policies are processed in the order that they're displayed (the first policy has the **Priority** value 0). The default anti-malware policy named Default has the priority value **Lowest**, and you can't change it.

1. In the security center, go to **Email & Collaboration** \> **Policies & Rules** \> **Threat policies** \> **Anti-malware**.

2. Select a custom policy from the list by clicking on the name of the policy. At the top of the policy details flyout that appears, you'll see **Increase priority** or **Decrease priority** based on the current priority value and the number of custom policies:
   - The anti-malware policy with the **Priority** value **0** has only the **Decrease priority** option available.
   - The anti-malware policy with the lowest **Priority** value (for example, **3**) has only the **Increase priority** option available.
   - If you have three or more anti-malware policies, policies between the highest and lowest priority values have both the **Increase priority** and **Decrease priority** options available.

3. Click ![Increase priority icon](../../media/m365-cc-sc-increase-icon.png) **Increase priority** or ![Decrease priority icon](../../media/m365-cc-sc-decrease-icon.png) **Decrease priority** to change the **Priority** value.

4. When you're finished, click **Close** in the policy details flyout.

## Use the security center to remove anti-malware policies

When you use the security center to remove an anti-malware policy, the malware filter rule and the corresponding malware filter policy are both deleted.

1. In the security center, go to **Email & Collaboration** \> **Policies & Rules** \> **Threat policies** \> **Anti-malware**.

2. Select a custom policy from the list by clicking on the name of the policy. At the top of the policy details flyout that appears, click ![More actions icon](../../media/m365-cc-sc-more-actions-icon.png) **More actions** \> ![Delete policy icon](../../media/m365-cc-sc-delete-icon.png) **Delete policy**.

3. In the confirmation dialog that appears, click **Yes**.

## Use Exchange Online PowerShell or standalone EOP PowerShell to configure anti-malware policies

### Use PowerShell to create anti-malware policies

Creating an anti-malware policy in PowerShell is a two-step process:

1. Create the malware filter policy.
2. Create the malware filter rule that specifies the malware filter policy that the rule applies to.

 **Notes**:

- You can create a new malware filter rule and assign an existing, unassociated malware filter policy to it. A malware filter rule can't be associated with more than one malware filter policy.
- There are two settings that you can configure on new anti-malware policies in PowerShell that aren't available in the security center until after you create the policy:
  - Create the new policy as disabled (_Enabled_ `$false` on the **New-MalwareFilterRule** cmdlet).
  - Set the priority of the policy during creation (_Priority_ _\<Number\>_) on the **New-MalwareFilterRule** cmdlet).
- A new malware filter policy that you create in PowerShell isn't visible in the security center until you assign the policy to a malware filter rule.

#### Step 1: Use PowerShell to create a malware filter policy

**Note**: In the cloud-based service, the _Action_ parameter values `DeleteMessage`, `DeleteAttachmentAndUseDefaultAlert`, and `DeleteAttachmentAndUseCustomAlert` don't delete messages. Instead, the messages are quarantined. For more information about retrieving quarantined messages, see [Manage quarantined messages and files as an admin in EOP](manage-quarantined-messages-and-files.md).

To create a malware filter policy, use this syntax:

```PowerShell
New-MalwareFilterPolicy -Name "<PolicyName>" [-Action <DeleteMessage | DeleteAttachmentAndUseDefaultAlert | DeleteAttachmentAndUseCustomAlert>] [-AdminDisplayName "<OptionalComments>"] [-CustomNotifications <$true | $false>] [<Inbound notification options>] [<Outbound notification options>]
```

This example creates a new malware filter policy named Contoso Malware Filter Policy with these settings:

- Quarantine messages that contain malware without notifying the recipients (we aren't using the _Action_ parameter, and the default value is `DeleteMessage`).
- Don't notify the message sender when malware is detected in the message (we aren't using the _EnableExternalSenderNotifications_ or _EnableInternalSenderNotifications_ parameters, and the default value for both is `$false`).
- Notify the administrator admin@contoso.com when malware is detected in a message from an internal sender.

```PowerShell
New-MalwareFilterPolicy -Name "Contoso Malware Filter Policy" -EnableInternalSenderAdminNotifications $true -InternalSenderAdminAddress admin@contoso.com
```

For detailed syntax and parameter information, see [New-MalwareFilterPolicy](/powershell/module/exchange/new-malwarefilterpolicy).

#### Step 2: Use PowerShell to create a malware filter rule

To create a malware filter rule, use this syntax:

```PowerShell
New-MalwareFilterRule -Name "<RuleName>" -MalwareFilterPolicy "<PolicyName>" <Recipient filters> [<Recipient filter exceptions>] [-Comments "<OptionalComments>"]
```

This example creates a new malware filter rule named Contoso Recipients with these settings:

- The malware filter policy named Contoso Malware Filter Policy is associated with the rule.
- The rule applies to recipients in the contoso.com domain.

```PowerShell
New-MalwareFilterRule -Name "Contoso Recipients" -MalwareFilterPolicy "Contoso Malware Filter Policy" -RecipientDomainIs contoso.com
```

For detailed syntax and parameter information, see [New-MalwareFilterRule](/powershell/module/exchange/new-malwarefilterrule).

### Use PowerShell to view malware filter policies

To return a summary list of all malware filter policies, run this command:

```PowerShell
Get-MalwareFilterPolicy
```

To return detailed information about a specific malware filter policy, use the this syntax:

```PowerShell
Get-MalwareFilterPolicy -Identity "<PolicyName>" | Format-List [<Specific properties to view>]
```

This example returns all the property values for the malware filter policy named Executives.

```PowerShell
Get-MalwareFilterPolicy -Identity "Executives" | Format-List
```

This example returns only the specified properties for the same policy.

```PowerShell
Get-MalwareFilterPolicy -Identity "Executives" | Format-List Action,AdminDisplayName,CustomNotifications,Enable*Notifications
```

For detailed syntax and parameter information, see [Get-MalwareFilterPolicy](/powershell/module/exchange/get-malwarefilterpolicy).

### Use PowerShell to view malware filter rules

To return a summary list of all malware filter rules, run this command:

```PowerShell
Get-MalwareFilterRule
```

To filter the list by enabled or disabled rules, run the following commands:

```PowerShell
Get-HostedContentFilterRule -State Disabled
```

```PowerShell
Get-HostedContentFilterRule -State Enabled
```

To return detailed information about a specific malware filter rule, use this syntax:

```PowerShell
Get-MalwareFilterRule -Identity "<RuleName>" | Format-List [<Specific properties to view>]
```

This example returns all the property values for the malware filter rule named Executives.

```PowerShell
Get-MalwareFilterRule -Identity "Executives" | Format-List
```

This example returns only the specified properties for the same rule.

```PowerShell
Get-MalwareFilterRule -Identity "Executives" | Format-List Name,Priority,State,MalwareFilterPolicy,*Is,*SentTo,*MemberOf
```

For detailed syntax and parameter information, see [Get-MalwareFilterRule](/powershell/module/exchange/get-malwarefilterrule).

### Use PowerShell to modify malware filter policies

Other than the following items, the same settings are available when you modify a malware filter policy in PowerShell as when you create the policy as described in the [Step 1: Use PowerShell to create a malware filter policy](#step-1-use-powershell-to-create-a-malware-filter-policy) section earlier in this article.

- The _MakeDefault_ switch that turns the specified policy into the default policy (applied to everyone, unmodifiable **Lowest** priority, and you can't delete it) is only available when you modify a malware filter policy in PowerShell.
- You can't rename a malware filter policy (the **Set-MalwareFilterPolicy** cmdlet has no _Name_ parameter). When you rename an anti-malware policy in the security center, you're only renaming the malware filter _rule_.

To modify a malware filter policy, use this syntax:

```PowerShell
Set-MalwareFilterPolicy -Identity "<PolicyName>" <Settings>
```

For detailed syntax and parameter information, see [Set-MalwareFilterPolicy](/powershell/module/exchange/set-malwarefilterpolicy).

### Use PowerShell to modify malware filter rules

The only setting that isn't available when you modify a malware filter rule in PowerShell is the _Enabled_ parameter that allows you to create a disabled rule. To enable or disable existing malware filter rules, see the next section.

Otherwise, no additional settings are available when you modify a malware filter rule in PowerShell. The same settings are available when you create a rule as described in the [Step 2: Use PowerShell to create a malware filter rule](#step-2-use-powershell-to-create-a-malware-filter-rule) section earlier in this article.

To modify a malware filter rule, use this syntax:

```PowerShell
Set-MalwareFilterRule -Identity "<RuleName>" <Settings>
```

For detailed syntax and parameter information, see [Set-MalwareFilterRule](/powershell/module/exchange/set-malwarefilterrule).

### Use PowerShell to enable or disable malware filter rules

Enabling or disabling a malware filter rule in PowerShell enables or disables the whole anti-malware policy (the malware filter rule and the assigned malware filter policy). You can't enable or disable the default anti-malware policy (it's always always applied to all recipients).

To enable or disable a malware filter rule in PowerShell, use this syntax:

```PowerShell
<Enable-MalwareFilterRule | Disable-MalwareFilterRule> -Identity "<RuleName>"
```

This example disables the malware filter rule named Marketing Department.

```PowerShell
Disable-MalwareFilterRule -Identity "Marketing Department"
```

This example enables same rule.

```PowerShell
Enable-MalwareFilterRule -Identity "Marketing Department"
```

For detailed syntax and parameter information, see [Enable-MalwareFilterRule](/powershell/module/exchange/enable-malwarefilterrule) and [Disable-MalwareFilterRule](/powershell/module/exchange/disable-malwarefilterrule).

### Use PowerShell to set the priority of malware filter rules

The highest priority value you can set on a rule is 0. The lowest value you can set depends on the number of rules. For example, if you have five rules, you can use the priority values 0 through 4. Changing the priority of an existing rule can have a cascading effect on other rules. For example, if you have five custom rules (priorities 0 through 4), and you change the priority of a rule to 2, the existing rule with priority 2 is changed to priority 3, and the rule with priority 3 is changed to priority 4.

To set the priority of a malware filter rule in PowerShell, use the following syntax:

```PowerShell
Set-MalwareFilterRule -Identity "<RuleName>" -Priority <Number>
```

This example sets the priority of the rule named Marketing Department to 2. All existing rules that have a priority less than or equal to 2 are decreased by 1 (their priority numbers are increased by 1).

```PowerShell
Set-MalwareFilterRule -Identity "Marketing Department" -Priority 2
```

**Notes**:

- To set the priority of a new rule when you create it, use the _Priority_ parameter on the **New-MalwareFilterRule** cmdlet instead.
- The default malware filter policy doesn't have a corresponding malware filter rule, and it always has the unmodifiable priority value **Lowest**.

### Use PowerShell to remove malware filter policies

When you use PowerShell to remove a malware filter policy, the corresponding malware filter rule isn't removed.

To remove a malware filter policy in PowerShell, use this syntax:

```PowerShell
Remove-MalwareFilterPolicy -Identity "<PolicyName>"
```

This example removes the malware filter policy named Marketing Department.

```PowerShell
Remove-MalwareFilterPolicy -Identity "Marketing Department"
```

For detailed syntax and parameter information, see [Remove-MalwareFilterPolicy](/powershell/module/exchange/remove-malwarefilterpolicy).

### Use PowerShell to remove malware filter rules

When you use PowerShell to remove a malware filter rule, the corresponding malware filter policy isn't removed.

To remove a malware filter rule in PowerShell, use this syntax:

```PowerShell
Remove-MalwareFilterRule -Identity "<PolicyName>"
```

This example removes the malware filter rule named Marketing Department.

```PowerShell
Remove-MalwareFilterRule -Identity "Marketing Department"
```

For detailed syntax and parameter information, see [Remove-MalwareFilterRule](/powershell/module/exchange/remove-malwarefilterrule).

## How do you know these procedures worked?

### Use the EICAR.TXT file to verify your anti-malware policy settings

> [!IMPORTANT]
> The EICAR.TXT file is not a virus. The European Institute for Computer Antivirus Research (EICAR) developed this file to safely test anti-virus installations and settings.

1. Open Notepad and paste the following text into an empty file:

   ```Text
   X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
   ```

   Be sure that these are the only text characters in the file. The file size should be 68 bytes.

2. Save the file as EICAR.TXT

   In your desktop anti-virus program, be sure to exclude the EICAR.TXT from scanning (otherwise, the file will be quarantined).

3. Send an email message that contains the EICAR.TXT file as an attachment, using an email client that won't automatically block the file. Use your anti-malware policy settings to determine the following scenarios to test:
   - Email from an internal mailbox to an internal recipient.
   - Email from an internal mailbox to an external recipient.
   - Email from an external mailbox to an internal recipient.

4. Verify that the message was quarantined, and verify the recipient and sender notification results based on your anti-malware policy settings. For example:

   - Recipients aren't notified, or recipients receive the original message with the EICAR.TXT attachment replaced by **Malware Alert Text.txt** that contains the default or customized text.
   - Internal or external senders are notified with the default or customized notification messages.
   - The admin email address that you specified is notified for internal or external message senders, with the default or customized notification messages.

5. Delete the EICAR.TXT file after your testing is complete (so other users aren't unnecessarily alarmed by it).
